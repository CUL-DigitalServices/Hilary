/*!
 * Copyright 2013 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var _ = require('underscore');
var assert = require('assert');
var fs = require('fs');
var util = require('util');

var ConfigTestUtil = require('oae-config/lib/test/util');
var RestAPI = require('oae-rest');
var SearchAPI = require('oae-search');
var SearchTestsUtil = require('oae-search/lib/test/util');
var TestsUtil = require('oae-tests/lib/util');

describe('Journals', function() {

    var anonymousCamRestContext = null;
    var anonymousGlobalRestContext = null;
    var camAdminRestCtx = null;
    var globalAdminRestContext = null;
    var camUserRestContext = null;

    /*!
     * Create rest contexts that can be used while running tests
     */
    beforeEach(function(callback) {
        anonymousCamRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host);
        anonymousGlobalRestContext = TestsUtil.createGlobalRestContext();
        camAdminRestCtx = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.cam.host);
        globalAdminRestContext = TestsUtil.createGlobalAdminRestContext();

        // Generate a Cambridge user
        TestsUtil.generateTestUsers(camAdminRestCtx, 1, function(err, users, user) {
            camUserRestContext = user.restContext;
            return callback();
        });
    });

    /**
     * Utility method that returns a stream that points to a CSV-file
     *
     * @return {Stream}     A stream that points to a CSV-file that can be uploaded
     */
    var getFileStream = function() {
        var file = __dirname + '/data/journals.csv';
        return fs.createReadStream(file);
    };

    describe('#importJournals()', function() {

        /**
         * Test that verifies that parameters are verified when importing journals
         */
        it('verify parameters', function(callback) {
            RestAPI.Journals.importJournals(camAdminRestCtx, null, function(err) {
                assert.equal(err.code, 400);

                RestAPI.Journals.importJournals(camAdminRestCtx, [], function(err) {
                    assert.equal(err.code, 400);

                    RestAPI.Journals.importJournals(camAdminRestCtx, {}, function(err) {
                        assert.equal(err.code, 400);
                        return callback();
                    });
                });
            });
        });

        /**
         * Test that verifies that only authorized admins/users can import journals
         */
        it('verify permissions', function(callback) {
            RestAPI.Journals.importJournals(anonymousGlobalRestContext, {'journals': getFileStream()}, function(err) {
                assert.equal(err.code, 401);

                RestAPI.Journals.importJournals(anonymousCamRestContext, {'journals': getFileStream()}, function(err) {
                    assert.equal(err.code, 401);

                    RestAPI.Journals.importJournals(camUserRestContext, {'journals': getFileStream()}, function(err) {
                        assert.equal(err.code, 401);

                        RestAPI.Journals.importJournals(camAdminRestCtx, {'journals': getFileStream()}, function(err) {
                            assert.ok(!err);

                            RestAPI.Journals.importJournals(globalAdminRestContext, {'journals': getFileStream()}, function(err) {
                                assert.ok(!err);
                                return callback();
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that importing journals is successful
         */
        it('verify importing journals is successful', function(callback) {
            RestAPI.Journals.importJournals(camAdminRestCtx, {'journals': getFileStream()}, function(err) {
                assert.ok(!err);

                SearchTestsUtil.searchRefreshed(camUserRestContext, 'journals', null, {'q': 'Academic'}, function(err, data) {
                    assert.ok(!err);
                    assert.ok(data.total);
                    assert.ok(_.isArray(data.results));
                    _.each(data.results, function(journal) {
                        assert.equal(journal.resourceType, 'journal');
                    });
                    return callback();
                });
            });
        });
    });
});
