/*!
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var _ = require('underscore');
var LogAPI = require('oae-logger');

var Config = require('./config');
var TicketsZendeskAPI = require('oae-tickets-zendesk/lib/api');

/**
 * This module defines handlers for events which the oae-tickets-zendesk
 * package listens for.
 *
 * @api private
 */
var EventHandlers = exports.EventHandlers = function(options) {
    var that = {};

    options = options || {};
    var config = options.config || Config;
    var ticketsZendeskAPI = options.ticketsZendeskAPI || TicketsZendeskAPI;
    var log = options.log || LogAPI.logger('oae-tickets-zendesk');

    that.onTicketCreated = function(ctx, ticket) {
        log().debug(util.inspect(ctx.user().tenant), 'onTicketCreated()');
        var tenantAlias = ctx.user().tenant.alias;

        if (config.isZendeskForwardingEnabled(tenantAlias)) {
            ticketsZendeskAPI.createZendeskTicket(ctx, ticket, function(err, zendeskTicket) {
                if(err) {
                    log().error({
                        'err': err,
                        'oaeTicket': ticket
                    }, 'error creating zendesk ticket');
                } else {
                    log().info({
                        'oaeTicket': ticket,
                        'zendeskTicket': zendeskTicket
                    }, 'created zendesk ticket');
                }
            });
        }
    };

    return that;
};

// Export the public methods of the default EventHandlers instance
var defaultEventHandlers = new EventHandlers();

/**
 * Handles the oae-tickets' CREATED_TICKET event.
 *
 * @param  {Object}     ctx     The current context
 * @param  {Ticket}     ticket  The created ticket
 */
exports.onTicketCreated = defaultEventHandlers.onTicketCreated;
